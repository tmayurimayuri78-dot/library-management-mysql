CREATE DATABASE libaray_db;
use libaray_db;
CREATE TABLE Students(Students_id INT Primary Key,Name varChar(100),Email varChar(100),Join_Date DATE);
SHOW TABLES;
INSERT INTO Students VALUES (20,'Saranya R','saranyar@gmail.com','2023-09-11');
SELECT * FROM Students;

CREATE TABLE Books(Book_id INT PRIMARY KEY,Name VARCHAR(100),AUTHOR VARCHAR(100),Total_Copies INT,Available_cOPIES INT);
INSERT INTO Books VALUES(1, 'Python Basics', 'Guido', 10, 10),(2, 'DBMS', 'Navathe', 8, 8),(3, 'Java', 'James Gosling', 6, 6),(4, 'AI Intro', 'Stuart Russell', 5, 5),
(5, 'Data Science', 'Joel Grus', 7, 7);
SELECT * FROM Books;

CREATE TABLE Borrow(borrow_id INT auto_increment PRIMARY KEY,student_id INT,book_id INT,borrow_date DATE,return_date DATE);
ALTER TABLE Borrow CHANGE book_id Book_id INT;
ALTER TABLE Borrow ADD CONSTRAINT fk_books foreign key(Book_id) references Books(Book_id);
SHOW CREATE TABLE Borrow;
INSERT INTO Borrow (Students_id, Book_id, borrow_date, return_date)VALUES (20, 2, '2025-05-10', '2025-06-10');
SELECT * FROM Borrow;
CREATE TABLE Audit_Log (
    log_id INT AUTO_INCREMENT PRIMARY KEY,
    table_name VARCHAR(50),
    action_type VARCHAR(10),
    user_name VARCHAR(50),
    action_time DATETIME,
    old_data TEXT,
    new_data TEXT
);
INSERT INTO Audit_Log
VALUES (
    5,
    'Students',
    'UPDATE',
    'system_scheduler',
    '2026-03-01 00:00:01',
    'status=ACTIVE',
    'status=INACTIVE'
);
SELECT * FROM Audit_log;

CREATE INDEX idx_student ON Borrow(Students_id);
CREATE INDEX idx_book ON Borrow(Book_id);

SHOW VARIABLES LIKE 'secure_file_priv';
SET GLOBAL local_infile = 1;
SHOW VARIABLES LIKE 'local_infile';
LOAD DATA LOCAL INFILE 'D:/mysql/Project/students.csv'
INTO TABLE students
FIELDS TERMINATED BY ','
ENCLOSED BY '"'
LINES TERMINATED BY '\n'
IGNORE 1 ROWS;
SELECT * FROM students;

DELIMITER $$

CREATE TRIGGER borrow_insert_audit
AFTER INSERT ON borrow
FOR EACH ROW
BEGIN
    INSERT INTO audit_log
    (table_name, action_type, action_time, new_data)
    VALUES
    (
        'borrow',
        'INSERT',
        NOW(),
        CONCAT(
            'borrow_id=', NEW.borrow_id,
            ', student_id=', NEW.Students_id,
            ', book_id=', NEW.Book_id,
            ', borrow_date=', NEW.borrow_date
        )
    );
END$$

DELIMITER ;

INSERT INTO borrow (Students_id, Book_id, borrow_date)VALUES (20, 1, CURDATE());
SELECT * FROM audit_log;
UPDATE Books SET available_copies = available_copies - 1 WHERE book_id = 2;
UPDATE Borrow SET return_date = CURDATE() WHERE borrow_id = 1;
UPDATE Books SET available_copies = available_copies + 1 WHERE book_id = 2;

DELIMITER //

CREATE FUNCTION calculate_fine(due DATE, ret DATE)
RETURNS INT
DETERMINISTIC
BEGIN
    DECLARE fine INT;

    IF ret > due THEN
        SET fine = DATEDIFF(ret, due) * 5;
    ELSE
        SET fine = 0;
    END IF;

    RETURN fine;
END//

DELIMITER ;

UPDATE Borrow SET fine_amount = calculate_fine(due_date, return_date) WHERE return_date IS NOT NULL;
CREATE EVENT daily_fine_update
ON SCHEDULE EVERY 1 DAY
DO
UPDATE Borrow
SET fine_amount = calculate_fine(due_date, CURDATE())
WHERE return_date IS NULL AND CURDATE() > due_date;
CREATE TRIGGER audit_borrow_insert
AFTER INSERT ON Borrow
FOR EACH ROW
INSERT INTO Audit_Log
VALUES (
    NULL,
    'Borrow',
    'INSERT',
    USER(),
    NOW(),
    NULL,
    CONCAT('Student:', NEW.Students_id, ', Book:', NEW.Book_id)
);
SELECT * FROM Borrow
WHERE return_date IS NULL AND CURDATE() > due_date;

SELECT Students_id, SUM(fine_amount) AS total_fine
FROM Borrow
GROUP BY Students_id
ORDER BY total_fine DESC;

SELECT Book_id, COUNT(*) AS times_borrowed
FROM Borrow
GROUP BY Book_id
ORDER BY times_borrowed DESC;

SELECT COUNT(*) FROM Students;

SELECT MONTH(borrow_date), COUNT(*)
FROM Borrow
GROUP BY MONTH(borrow_date);

















